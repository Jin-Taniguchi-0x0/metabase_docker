services:
  # 1. Metabaseが内部データを保存するための専用DB
  metabase_app_db:
    image: postgres:${POSTGRES_VERSION}
    container_name: ${CONTAINER_NAME}
    hostname: ${HOSTNAME}
    ports:
      - "5432:5432"
    restart: always
    environment:
      - POSTGRES_USER=${USER_NAME}
      - POSTGRES_PASSWORD=${USER_PASS}
      - POSTGRES_DB=${DB_NAME}
    networks:
      - metanet1
    volumes:
      - metabase_postgres_data:/var/lib/postgresql/data

  # 2. wineReview.csv や social_media_ads.csv を格納する分析用DB
  data_db:
    image: postgres:${DATA_DB_POSTGRES_VERSION}
    container_name: ${DATA_DB_CONTAINER_NAME}
    hostname: ${DATA_DB_HOSTNAME}
    ports:
      - "5433:5432"
    restart: always
    environment:
      - POSTGRES_USER=${DATA_DB_USER}
      - POSTGRES_PASSWORD=${DATA_DB_PASS}
      - POSTGRES_DB=${DATA_DB_NAME}
    networks:
      - metanet1
    volumes:
      # init_data_db.sh と csv ファイルが入ったフォルダをマウント
      - ./data_init:/docker-entrypoint-initdb.d

  # Metabase 本体
  metabase:
    platform: linux/x86_64
    image: metabase/metabase:latest
    container_name: metabase
    hostname: metabase
    ports:
      - 3000:3000
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: ${DB_NAME}
      MB_DB_PORT: 5432
      MB_DB_USER: ${USER_NAME}
      MB_DB_PASS: ${USER_PASS}
      MB_DB_HOST: ${HOSTNAME}
      MB_DB_CONNECTION_URI: postgresql://${USER_NAME}:${USER_PASS}@${HOSTNAME}:5432/${DB_NAME}
    networks:
      - metanet1
    healthcheck:
      test: curl --fail -I http://localhost:3000/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 6g

  # Python アプリ
  python-app:
    build:
      context: ./python-app
      dockerfile: Dockerfile
    container_name: python-app
    hostname: python-app
    depends_on:
      - metabase
    networks:
      - metanet1
    volumes:
      - ./python-app:/app
    environment:
      # 【追加】分析用DBへの接続情報を環境変数として渡す
      - DATA_DB_HOST=${DATA_DB_HOSTNAME}
      - DATA_DB_NAME=${DATA_DB_NAME}
      - DATA_DB_USER=${DATA_DB_USER}
      - DATA_DB_PASS=${DATA_DB_PASS}
      - DATA_DB_PORT=5432
    entrypoint: ["sh", "-c", "while ! nc -z metabase 3000; do sleep 1; done; streamlit run app.py --server.port 8080"]
    ports:
      - 8080:8080
    healthcheck:
      test: curl --fail -I http://localhost:8080 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  metabase_postgres_data:

networks:
  metanet1:
    driver: bridge